import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.text.SimpleDateFormat;
import java.util.Arrays;

import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest
public class FinancementServiceTest {

    @Autowired
    private FinancementService financementService;

    @Autowired
    private FinancementRepository financementRepository;

    private final SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSXXX");

    @Test
    public void testPatchFinancementChamps() throws Exception {
        // Setup initial Financement object
        ArrayList<String> idReper = new ArrayList<>(Arrays.asList("0123456789"));
        Financement existing = new Financement();
        existing.setIdFinancement("FZM2CSEVQ");
        ObjetFinancement objetFinancement = new ObjetFinancement();
        Bien bien = new Bien();
        bien.setNumeroNomRue("13 bis");
        bien.setSurfaceBien(200.0);
        bien.setDateDepotPc(dateFormat.parse("2024-05-26T07:07:41.000+00:00"));
        objetFinancement.setBien(bien);
        existing.setObjetFinancement(objetFinancement);
        existing.setIntervenant(Intervenant.builder()
                .idReper(idReper)
                .build());
        financementRepository.save(existing);

        // Setup Financement update object
        Financement update = new Financement();
        ObjetFinancement updateObjetFinancement = new ObjetFinancement();
        Bien updateBien = new Bien();
        updateBien.setMontantFinanceLCL(3300000.0); // Only updating montantFinanceLCL
        updateBien.setPartLCL(7400000.0); // Only updating partLCL
        updateBien.setDateDepotPc(" "); // Setting dateDepotPc to empty string
        updateObjetFinancement.setBien(updateBien);
        update.setObjetFinancement(updateObjetFinancement);

        // Call patch method
        Financement result = financementService.patchFinancementChamps("FZM2CSEVQ", update);

        // Validate the result
        assertEquals("13 bis", result.getObjetFinancement().getBien().getNumeroNomRue()); // Should not be null or changed
        assertEquals(200.0, result.getObjetFinancement().getBien().getSurfaceBien(), 0.0); // Should not be changed
        assertEquals(3300000.0, result.getObjetFinancement().getBien().getMontantFinanceLCL(), 0.0);
        assertEquals(7400000.0, result.getObjetFinancement().getBien().getPartLCL(), 0.0);
        assertNull(result.getObjetFinancement().getBien().getDateDepotPc()); // Should be set to null
    }
}
