import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Map;
import java.util.Objects;

@Service
public class FinancementService {

    @Autowired
    private FinancementRepository financementRepository;

    private final ObjectMapper objectMapper;

    public FinancementService() {
        this.objectMapper = new ObjectMapper();
        this.objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
    }

    public Financement patchFinancementChamps(String idFinancement, Financement financementToUpdate) {
        Financement existingFinancement = financementRepository.findByidFinancement(idFinancement)
                .orElseThrow(() -> new FinancementNotFoundException("Le financement Ã  modifier est inexistant"));

        merge(existingFinancement, financementToUpdate);

        // Enregistrer les modifications
        return financementRepository.save(existingFinancement);
    }

    private void merge(Object target, Object source) {
        // Convert source object to a map
        Map<String, Object> sourceMap = objectMapper.convertValue(source, Map.class);

        // Remove entries with null or empty values
        sourceMap.values().removeIf(Objects::isNull);

        // Merge source map into target object
        objectMapper.readerForUpdating(target).readValue(objectMapper.writeValueAsString(sourceMap));
    }
}
