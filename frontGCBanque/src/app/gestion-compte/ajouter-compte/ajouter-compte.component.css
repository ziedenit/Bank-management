package com.cl.msofd.regleProcess;

import org.springframework.batch.core.Job;
import org.springframework.batch.core.Step;
import org.springframework.batch.core.configuration.annotation.EnableBatchProcessing;
import org.springframework.batch.core.configuration.annotation.JobBuilderFactory;
import org.springframework.batch.core.configuration.annotation.StepBuilderFactory;
import org.springframework.batch.core.job.builder.JobBuilder;
import org.springframework.batch.core.step.builder.StepBuilder;
import org.springframework.batch.core.launch.support.RunIdIncrementer;
import org.springframework.batch.core.step.tasklet.Tasklet;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
@EnableBatchProcessing
public class BatchConfiguration {

    @Bean
    public Job importUserJob(JobBuilder jobBuilder, StepBuilder stepBuilder, Tasklet step1Tasklet) {
        Step step1 = stepBuilder.get("step1")
                .tasklet(step1Tasklet)
                .build();

        return jobBuilder.get("importUserJob")
                .incrementer(new RunIdIncrementer())
                .start(step1)
                .build();
    }

    @Bean
    public JobBuilder jobBuilder(JobBuilderFactory jobBuilderFactory) {
        return jobBuilderFactory.get("importUserJob");
    }

    @Bean
    public StepBuilder stepBuilder(StepBuilderFactory stepBuilderFactory) {
        return stepBuilderFactory.get("step1");
    }
}
//
package com.cl.msofd.regleProcess;

import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.springframework.batch.core.StepContribution;
import org.springframework.batch.core.step.tasklet.Tasklet;
import org.springframework.batch.core.scope.context.ChunkContext;
import org.springframework.batch.repeat.RepeatStatus;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.core.io.Resource;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.stereotype.Component;

import java.io.InputStream;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

@Component
public class ExcelReaderTasklet implements Tasklet {

    @Value("classpath:your-file.xlsx")
    private Resource resource;

    private final MongoTemplate mongoTemplate;

    public ExcelReaderTasklet(MongoTemplate mongoTemplate) {
        this.mongoTemplate = mongoTemplate;
    }

    @Override
    public RepeatStatus execute(StepContribution stepContribution, ChunkContext chunkContext) throws Exception {
        InputStream inputStream = resource.getInputStream();
        Workbook workbook = new XSSFWorkbook(inputStream);
        Sheet sheet = workbook.getSheetAt(0);

        for (Row row : sheet) {
            Map<String, Object> regle = new HashMap<>();
            regle.put("eligibleDEP", parseEligibleDEP(row.getCell(0).getStringCellValue()));
            regle.put("dateDepotPc", parseDate(row.getCell(1).getStringCellValue()));
            regle.put("presenseDateDpeJustif", row.getCell(2).getStringCellValue().equalsIgnoreCase("oui"));
            regle.put("presenseDpe", row.getCell(3).getStringCellValue().equalsIgnoreCase("oui"));
            regle.put("dateConstruction", parseDate(row.getCell(4).getStringCellValue()));
            regle.put("classeCEP", row.getCell(5).getStringCellValue());
            regle.put("valeurCep", parseDouble(row.getCell(6).getStringCellValue()));
            regle.put("justifNormeThermique", row.getCell(7).getStringCellValue().equalsIgnoreCase("oui"));
            regle.put("normeThermique", row.getCell(8).getNumericCellValue());
            regle.put("xtra248eligible", row.getCell(9).getNumericCellValue());
            regle.put("xtra249dedie", row.getCell(10).getStringCellValue());
            regle.put("xtra250Alignement", row.getCell(11).getNumericCellValue());
            regle.put("xtra251", row.getCell(12).getNumericCellValue());
            regle.put("xtra275", row.getCell(13).getStringCellValue().equalsIgnoreCase("Y"));

            mongoTemplate.save(regle, "regles");
        }

        workbook.close();
        inputStream.close();

        return RepeatStatus.FINISHED;
    }

    private Boolean parseEligibleDEP(String value) {
        return "Autre bien immobilier".equalsIgnoreCase(value);
    }

    private Date parseDate(String dateStr) throws ParseException {
        SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yyyy");
        if (dateStr.contains("au")) {
            String[] dates = dateStr.split(" au ");
            return sdf.parse(dates[0].trim()); // Returning the start date for simplicity
        } else if (dateStr.contains("avant")) {
            return sdf.parse(dateStr.replace("avant ", "").trim());
        } else if (dateStr.contains("après")) {
            return sdf.parse(dateStr.replace("après ", "").trim());
        }
        return null;
    }

    private Double parseDouble(String value) {
        return Double.parseDouble(value.replace("≤", "").replace(">", "").trim());
    }
}
